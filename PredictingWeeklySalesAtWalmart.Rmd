---
title: "Predicting Weekly Sales at WalMart Stores"
author: ""
date: "August 31, 2015"
output: 
  html_document:
    toc: true
    theme: cerulean
---


```{r setup, echo=FALSE , include=FALSE}
# Setting up the R Markdown Report
# echo & include is set to false because I do not want this on the report

# enabling cache so we don't have to run the code everytime
knitr::opts_chunk$set(cache=TRUE)  
# width of the report
options(width=80)
```

<BR>

# 1. Executive Summary
Retail stores need to be able to predict sales forecasts for the future and study the effect how strategic offers affect sales, especially during holiday season. Since the number of days in holidays are limited, it becomes more challenging to be able to accruately predict how different aspects affect sales.

The report will attempt to create a predictive model for WalMart a store's Weekly Sales and store department-wise Weekly Sales.


# 2. Introduction


## 2.1 About the Solution Environment
The authors implemented this solution in R. We have used R Markdown Report to create this document. First we explore and prepare the data set before carrying out formal statistical inferences on the dataset. We wrap the report by building a model to predict Weekly sales for the 45 stores in this dataset.


## 2.2 About the Data
The dataset under consideration is taken from a recruitment competition WalMart ran on Kaggle between February-May 2014. The participants were supposed to create a model to be able to predict Weekly Sales for 45 Stores located in different regions. Each store has multiple departments and the end requirement is to be able to predict the sales for individual departments of each store.


### 2.2.1 The Challenge
The challenge is to be able to predict how different holiday price markdowns affect the various departments in the store, to model extent of impact of these markdowns.

<IMAGE src="Images/markdowns.png" />


## 2.3 Getting the Data
The data was download from Kaggle.

URL to the Kaggle Competition Site: https://www.kaggle.com/c/walmart-recruiting-store-sales-forecasting

The files available are the following:<BR>
<IMAGE src="Images/DataFilesImage.png" />

### 2.3.1 The Data Files
Here we discuss the various CSV Files that are given by WalMart.

#### 2.3.1.1 stores.csv
Contains size and type of 45 stores (45 records).

#### 2.3.1.2 train.csv
Weekly sales dataset from Februray 05, 2010 to November 11, 2012. It contains the following fields:

* Store: store number
* Dept: the department number
* Date: week date
* Weekly_Sales: sales for the given department in the given store
* IsHoliday: whether the week is a special holiday week

#### 2.3.1.3 test.csv
The dataset with similar fields as train.csv, except without Weekly_Sales. This will be used to test the model with unseen data and can be evaulated by uploading the dataset to Kaggle.

#### 2.3.1.4 features.csv
This data file contains additional relevant information relating to the physical and business environment around the store. The fields are as follows:

* Store: store number
* Date: the week date
* Temperature: the average temperature in the region
* Fuel_Price: cost of fuel in the region
* MarkDown1-5: data related to the markdowns that Walmart is running. Markdown data is only available after November 2011 and is not available for all stores all the time. Any missing value is marked with an NA.
* CPI - the Consumer Price Index
* Unemployment - the unemployment rate
* IsHoliday - whether the week is a special holiday week

The four holidays fall inthe following weeks in the dataset:

* Super Bowl: 12-Feb-10, 11-Feb-11, 10-Feb-12, 8-Feb-13
* Labor Day: 10-Sep-10, 9-Sep-11, 7-Sep-12, 6-Sep-13
* Thanksgiving: 26-Nov-10, 25-Nov-11, 23-Nov-12, 29-Nov-13
* Christmas: 31-Dec-10, 30-Dec-11, 28-Dec-12, 27-Dec-13

### 2.3.2 Ingesting the Data
```{r ingest}
## Ingesting the data from the Data folder
train <- read.csv("Data/train.csv")
stores <- read.csv("Data/stores.csv")
features <- read.csv("Data/features.csv")
test <- read.csv("Data/test.csv")
```

## 2.4 Libraries Used
The following libraries are used in this report:

```{r librariesUsed}
# Grammar of Graphics Plotting Library
library(ggplot2)
```


<BR>

# 3. Stage 1: Data Exploration and Preparation

## 3.1 Summary Statististics

### 3.1.1 The Training Dataset (train)
```{r trainDatasetStr}
str(train)
```

<BR>

<code>Date</code> is ingested as factor (as opposed to being ingested as date type). There are 143 dates in total.

```{r trainDatasetSummary}
## Changing the Date from "Format" type to "Date" Type 
train$Date <- as.Date(train$Date)
## Getting the summary of the Data
summary(train)
```

<BR>
There is no missing data in the dataset.

As discussed in the Introduction, this report contains data of 45 stores - represented by Store. There are a total of 99 stores in all.

The starting date for training dataset is ```r min(train$Date)```. It starts on a ```r weekdays(min(train$Date) )```. The last date recorded in the dataset is ```r max(train$Date)```, which is also a ```r weekdays( max( train$Date ) )```. There are ```r days<- as.numeric( max( train$Date )  - min(train$Date) ); days``` days between them - so the data consists of a total of ```r days/7 + 1``` weeks of data.

It is interesting to note that for some departments the <code>Weekly_Sales</code> are negative. Returns and special offers cause these negative sales figures.

There are no missing values in this dataset.

### 3.1.2 The Stores Dataset (stores)
```{r storesDatasetStr}
## Structure of Stores Dataset
str(stores)
```

```{r storesSummary}
## summary Statistics of Stores dataset
summary(stores)
```

No missing data.



### 3.1.3 The Features Dataset (features)

```{r featuresDatasetStr}
## Structure of features dataset
str(features)
```

<code>Date</code> is ingested as factor (as opposed to being ingested as date type). There are 182 dates in total. This dataset is relevant for both the <code>train</code> and the <code>test</code> dataset.

```{r featuresSummary}
## Changing the Date from "Format" type to "Date" Type 
features$Date <- as.Date(features$Date)
## Summary Statistics of Features Dataset
summary(features)
```

The <code>features</code> dataset has missing variables for <code>Markdown1-5</code>, <code>CPI</code> & <code>Unemployment</code>.

### 3.1.4 The Test Dataset (test)

```{r testDatasetStr}
## Structure of test dataset
str(test)
```

<code>Date</code> is ingested as factor (as opposed to being ingested as date type). There are 39 dates in total.

```{r testSummary}
## Changing the Date from "Format" type to "Date" Type 
test$Date <- as.Date(test$Date)
## Summary Statistics of test Dataset
summary(test)
```


## 3.2 Data Preparation - Merging the Datasets
### 3.2.1 Merging Train and Stores Datasets
Since the <code>Type</code> & <code>Size</code> variables may influence the Weekly Sales, we are merging the <code>train</code> & <stores</code> datasets. We merge the data by <code>Store</code>.

```{r mergeTrainStores}
## Merging train and stores by Store
trainStoresMerge <- merge(train , stores , by = "Store")
```

### 3.2.2 Merging Train, Stores and Features Datasets
Since <code>Markdown1-5</code> and other variables could play an important role at predicting <code>Weekly_Sales</code>, this should be merged with the <code>trainStoresMerge</code> dataset. We merge the data by <code>Store</code> & <code>Date</code>.

```{r mergeTrainStoresFeatures}
## Merging trainStoresMerge and features datasets
trainStoresFeaturesMerge <- merge( trainStoresMerge , features , by = c( "Store" , "Date" ) )
## Clearing memory - removing intermediate datasets
rm(trainStoresMerge , train)
## Fixing the name of the Column
colnames(trainStoresFeaturesMerge)[5] <- "IsHoliday"
trainStoresFeaturesMerge$IsHoliday.y <- NULL
```

### 3.2.3 Merging Test, Stores and Features Datasets
We similarily merge the <code>test</code>, <code>stores</code> & <code>features</code> to create the <code>testStoresFeaturesMerge</code> dataset.

```{r mergeTestStoresFeatures}
## Merging test and stores by Store
testStoresMerge <- merge(test , stores , by = "Store")
## Merging testStoresMerge and features datasets
testStoresFeaturesMerge <- merge( testStoresMerge , features , by = c( "Store" , "Date" ) )
## Clearing Memory - removing intermediate Datasets
rm( test , testStoresMerge , features )
## Fixing the name of the Column
colnames(testStoresFeaturesMerge)[5] <- "IsHoliday"
testStoresFeaturesMerge$IsHoliday.y <- NULL
```


## 3.3 Data Exploration

### 3.3.1 Total Sales Vs. Store Size
Plotting the total sales of a store vs. Store Size. We first calculate the total sales per Store and plot it as a response (y-axis) to the Store size (x-axis) to understand the relationship between them.

```{r salesStoreSize}
## Total Sales vs. Store Size - plotting the relationship
## calculating the sum of all the store sales
StoreTotalSales <- tapply(trainStoresFeaturesMerge$Weekly_Sales, trainStoresFeaturesMerge$Store, FUN = sum)
## converting the table to a DataFrame
stores$TotalSales <- StoreTotalSales
stores$TotalSalesInMillion <- stores$TotalSales/1000000
## Plotting the Total Sales vs. Store Size
ggplot( stores , aes(x=Size , y=TotalSalesInMillion , color = Type ) ) + 
  geom_point() +  
  scale_y_continuous(name="Total Sales in Millions" )
```

This plot indicates that there is a postive relationship between the size of the store and total sales. Also Type 'A' Stores are mostly larger stores with bigger sales and Type 'C' Stores are small with lower sales.

### 3.3.2 Store Sales - Time Series






# 4. Stage 2: Formal Statistical Inferences
## 4.1 Do Holiday Weeks Account for Higher Sales?
## 4.2 Are Sales 

# 5. Stage 3: Linear Regression: Predicting Weekly_Sales
## 5.1 Predicting Store Weekly_Sales
## 5.2 Predicting Store-Department Weekly_Sales
